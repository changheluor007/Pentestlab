# Windows基础-SMB协议与IPC$



## SMB协议

[NetBios, NetBios over TCP/IP, SMB 之间的关系](https://www.cnblogs.com/pipci/p/10144840.html)

https://en.wikipedia.org/wiki/Server_Message_Block

在计算机网络中，SMB协议是一种通信协议，用于提供文件共享，文件打印，以及带身份验证的进程间通信机制。SMB协议是客户端-服务器模式，SMB协议的主要涉及两部分功能：

- 一部分专门涉及对文件系统的访问，以便客户端可以向文件服务器发出请求；

- 另一部分专门研究进程间通信（IPC）

  Windows上IPC$就是此部分的一个典型应用。

  *我的理解：命名管道(named pipes)、socket、shared memory是实现进程间通信的三种方式，IPC$是基于named pipes，named pipes是基于SMB协议的；IPC,RPC是一个东西*

  

SMB协议是运行在会话层之上的网络层协议，有两种运行方式 ：

- 第一种通过NetBios API，使用的是UDP的137和138端口以及TCP的137和139的端口。

  如今，我们使用的网络协议栈是TCP/IP协议栈，在Windows操作系统上，NetBios运行在NetBios over TCP/IP的协议上，NetBios over TCP/IP（简称NBT或者NetBT）是一个网络协议，允许以前使用NetBios API的应用程序能够在现代的TCP/IP网络中。如下图：

  ![img](assets/382300-20160109151303168-1561702700.gif)

- 第二种是直接运行在TCP和UDP协议之上，使用的是445端口，可以称为"Direct hosting of SMB over TCP/IP"。





## IPC$

[An Introduction to SMB for Network Security Analysts](https://401trg.com/an-introduction-to-smb-for-network-security-analysts/)

[Abusing Windows Admin Shares (Lateral Movement)](https://www.youtube.com/watch?v=41MUhlHGZ4E&t=323s)

To begin an SMB session, the two participants agree on a dialect, authentication is performed, and the initiator connects to a ‘tree.’ For most intents and purposes, the tree can be thought of as a network share.

![image9](assets/image9.png)



Windows默认会开启3类network share，使用`net share`或`net view \\pc-name /all`可以查看：

1. c$, d$... 文件共享，对应本机C盘，D盘
2. ADMIN$ 文件共享，对应本机C:\Windows
3. IPC$，RPC接口、可以理解为一组named pipes server的入口

![image-20201122111311227](assets/image-20201122111311227.png)



### samr

<img src="assets/image-20201122111729095.png" alt="image-20201122111729095" style="zoom:150%;" />



### atsvc

![image3](assets/image3.png)



### svcctl&PSEXEC

PSEXEC可以使用以下命令远程执行命令，其原理就是先连接Admin$拷贝PSEXESVC.exe；再通过IPC$连接[svcctl](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-scmr/705b624a-13de-43cc-b8a2-99573da3635f)，远程创建并启动服务psexecsvc；客户端连接执行命令，服务端启动相应的程序并执行回显数据

```
net use \\win10-pc4\ipc$ “Test1234” /user:dell
psexec.exe \\win10-pc4 cmd.exe     

或 

PsExec64.exe -accepteula \\win10-pc4 -u dell -p Test1234 cmd.exe
```



以上命令不需要以管理员权限执行，PsExec64.exe加了`-s`参数，则目标机器上可执行程序是以`system`权限启动，否则以`medium`权限启动。

![image-20201122114024455](assets/image-20201122114024455.png)

![image1](assets/image1.png)

![image2](assets/image2.png)



