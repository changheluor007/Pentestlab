# 渗透测试-导出Chrome浏览器中保存的密码



## 环境

Chrome版本:  85.0.4183.83

LaZagne版本: https://github.com/AlessandroZ/LaZagne/tree/v2.4.2

360浏览器版本: 

 ![image-20201022063632255](C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20201022063632255.png)



**参考**

[本地密码查看工具LaZagne中的自定义脚本开发](https://3gstudent.github.io/3gstudent.github.io/%E6%9C%AC%E5%9C%B0%E5%AF%86%E7%A0%81%E6%9F%A5%E7%9C%8B%E5%B7%A5%E5%85%B7LaZagne%E4%B8%AD%E7%9A%84%E8%87%AA%E5%AE%9A%E4%B9%89%E8%84%9A%E6%9C%AC%E5%BC%80%E5%8F%91/)

[渗透技巧——导出Chrome浏览器中保存的密码](https://3gstudent.github.io/3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-%E5%AF%BC%E5%87%BAChrome%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%AD%E4%BF%9D%E5%AD%98%E7%9A%84%E5%AF%86%E7%A0%81/)

[渗透技巧——离线导出Chrome浏览器中保存的密码](https://3gstudent.github.io/3gstudent.github.io/渗透技巧-离线导出Chrome浏览器中保存的密码/)

## LaZagne Project

The **LaZagne project** is an open source application used to **retrieve lots of passwords** stored on a local computer. Each software stores its passwords using different techniques (plaintext, APIs, custom algorithms, databases, etc.). This tool has been developed for the purpose of finding these passwords for the most commonly-used software.

| Windows                              | Linux                                                        | Mac                                                          |                    |
| ------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------ |
| Browsers                             | 7Star Amigo BlackHawk Brave Centbrowser Chedot Chrome Canary Chromium Coccoc Comodo Dragon Comodo IceDragon Cyberfox Elements Browser Epic Privacy Browser Firefox Google Chrome Icecat K-Meleon Kometa Opera Orbitum Sputnik Torch Uran Vivaldi YandexBrowser | Chrome Firefox Opera                                         | Chrome Firefox     |
| Chats                                | Pigdin Psi Skype                                             | Pigdin Psi                                                   |                    |
| Databases                            | DBVisualizer Postgresql Robomongo Squirrel SQLdevelopper     | DBVisualizer Squirrel SQLdevelopper                          |                    |
| Games                                | GalconFusion Kalypsomedia RogueTale Turba                    |                                                              |                    |
| Git                                  | Git for Windows                                              |                                                              |                    |
| Mails                                | Outlook Thunderbird                                          | Clawsmail Thunderbird                                        |                    |
| Maven                                | Maven Apache                                                 |                                                              |                    |
| Dumps from memory                    | Keepass Mimikatz method                                      | System Password                                              |                    |
| Multimedia                           | EyeCON                                                       |                                                              |                    |
| PHP                                  | Composer                                                     |                                                              |                    |
| SVN                                  | Tortoise                                                     |                                                              |                    |
| Sysadmin                             | Apache Directory Studio CoreFTP CyberDuck FileZilla FTPNavigator OpenSSH OpenVPN PuttyCM RDPManager VNC WinSCP Windows Subsystem for Linux | AWS Docker Environnement variable FileZilla History files Shares SSH private keys |                    |
| Wifi                                 | Wireless Network                                             | Network Manager WPA Supplicant                               |                    |
| Internal mechanism passwords storage | Autologon MSCache Credential Files Credman DPAPI Hash Hashdump (LM/NT) LSA secret Vault Files | GNOME Keyring Kwallet Hashdump                               | Keychains Hashdump |

 

## Dump Chrome浏览器中保存的密码

DB文件: C:\Users\DELL\AppData\Local\Google\Chrome\User Data\Default\Login Data

1. 它是一个sqlite数据库文件，存储了url、账号、加密后的密码；
2. 密码使用Windows API [CryptProtectData()](https://docs.microsoft.com/en-us/windows/win32/api/dpapi/nf-dpapi-cryptprotectdata)加密，对应解密函数为[CryptUnprotectData()](https://docs.microsoft.com/en-us/windows/win32/api/dpapi/nf-dpapi-cryptunprotectdata)
   1. 解密需要用户凭据，加密时的设置(CRYPTPROTECT_LOCAL_MACHINE flag)决定了谁可以解密数据，一般情况下是设置加密的用户才可以解密数据。
   2. 通常只能在加密数据的计算机上进行解密，但如果一个用户有Roaming profile则可以解密其他机器上的Chrome Login Data文件。

使用sqlitestudio可以查看DB中数据，chrome打开是DB文件不能访问，可以先拷贝一份。

![image-20201024223938962](C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20201024223938962.png)



解密代码参考Windows\softwares\browsers\chromium_based.py中_export_credentials的实现：

```
        try:
            conn = sqlite3.connect(db_path)
            cursor = conn.cursor()
            cursor.execute(self.database_query)
        except Exception as e:
            self.debug(str(e))
            return credentials

        for url, login, password in cursor.fetchall():
            try:
                # Decrypt the Password
                password = Win32CryptUnprotectData(password, is_current_user=constant.is_current_user, user_dpapi=constant.user_dpapi)
                if not url and not login and not password:
                    continue
                    
                credentials.append((url, login, password))
            except Exception:
                self.debug(traceback.format_exc())

        conn.close()
```



关于用Roaming Profile离线解密其他机器上密码，可参考[0x04 如何导出另一系统下Chrome浏览器中保存的密码](https://3gstudent.github.io/3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-%E5%AF%BC%E5%87%BAChrome%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%AD%E4%BF%9D%E5%AD%98%E7%9A%84%E5%AF%86%E7%A0%81/)





## Dump 360浏览器中保存的密码

360浏览器是基于Chromium的，密码解密这部分逻辑是一样的，因此只要在代码chromium_based.py中加入一行360浏览器的配置即可。

![image-20201022071558645](C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20201022071558645.png)

![image-20201022072049516](C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20201022072049516.png)